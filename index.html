import logging
import sqlite3
import urllib.parse
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo
from telegram.constants import ChatMemberStatus, ParseMode
from telegram.ext import (
    ApplicationBuilder,
    ContextTypes,
    CommandHandler,
    MessageHandler,
    ChatMemberHandler,
    CallbackQueryHandler,
    filters
)

# --- SOZLAMALAR ---
TOKEN = "8223788937:AAF8g2oiMb2V2He4jCPav8T1eOaojyTrc3o"
MAIN_ADMIN_ID = 6787735720
WEBAPP_URL = "https://sahobiddinabdulhamid.github.io/Hammaga-Yetadi-Konkurs"
BOT_USERNAME = "@Hammaga_Yetadi_bot"

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)

# --- BAZA ---
def get_db(): return sqlite3.connect('konkurs_final.db')

def init_db():
    conn = get_db(); cursor = conn.cursor()
    cursor.execute('''CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY, full_name TEXT, username TEXT, invites INTEGER DEFAULT 0,
        invite_link TEXT, assigned_channel_id TEXT, pro_claimed_at TEXT, banned_until INTEGER DEFAULT 0)''')
    cursor.execute('''CREATE TABLE IF NOT EXISTS sponsors (channel_id TEXT PRIMARY KEY, title TEXT, url TEXT)''')
    cursor.execute('''CREATE TABLE IF NOT EXISTS targets (channel_id TEXT PRIMARY KEY, title TEXT, joined_count INTEGER DEFAULT 0)''')
    cursor.execute('''CREATE TABLE IF NOT EXISTS settings (key TEXT PRIMARY KEY, value TEXT)''')
    
    defaults = [
        ("required_invites", "3"), 
        ("course_link", "https://youtube.com"), 
        ("end_date", "31.12.2025"), 
        ("ad_text", "Reklama joyi"), 
        ("ad_link", "https://t.me/"), # Reklama Linki
        ("admin_contact", "https://t.me/admin"), 
        ("current_target_index", "0")
    ]
    for key, val in defaults:
        cursor.execute("INSERT OR IGNORE INTO settings (key, value) VALUES (?, ?)", (key, val))
    conn.commit(); conn.close()

init_db()

# --- YORDAMCHI FUNKSIYALAR ---
def get_setting(key):
    conn = get_db(); res = conn.cursor().execute("SELECT value FROM settings WHERE key=?", (key,)).fetchone()
    conn.close(); return res[0] if res else ""

def set_setting(key, value):
    conn = get_db(); conn.cursor().execute("INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)", (key, str(value)))
    conn.commit(); conn.close()

def add_sponsor(cid, title, url):
    conn = get_db(); conn.cursor().execute("INSERT OR REPLACE INTO sponsors VALUES (?, ?, ?)", (cid, title, url)); conn.commit(); conn.close()
def get_sponsors():
    conn = get_db(); res = conn.cursor().execute("SELECT * FROM sponsors").fetchall(); conn.close(); return res
def del_sponsor(cid):
    conn = get_db(); conn.cursor().execute("DELETE FROM sponsors WHERE channel_id=?", (cid,)); conn.commit(); conn.close()

def add_target(cid, title):
    conn = get_db(); conn.cursor().execute("INSERT OR REPLACE INTO targets (channel_id, title) VALUES (?, ?)", (cid, title)); conn.commit(); conn.close()
def get_targets():
    conn = get_db(); res = conn.cursor().execute("SELECT * FROM targets").fetchall(); conn.close(); return res
def del_target(cid):
    conn = get_db(); conn.cursor().execute("DELETE FROM targets WHERE channel_id=?", (cid,)); conn.commit(); conn.close()

def get_next_target_channel():
    targets = get_targets()
    if not targets: return None
    idx = int(get_setting('current_target_index') or 0)
    if idx >= len(targets): idx = 0 
    selected = targets[idx] 
    new_idx = (idx + 1) % len(targets)
    set_setting('current_target_index', new_idx)
    return selected[0], selected[1]

# --- URL YASASH ---
def generate_webapp_url_logic(user_first_name):
    course = urllib.parse.quote(get_setting('course_link'))
    end_d = urllib.parse.quote(get_setting('end_date'))
    ad_txt = urllib.parse.quote(get_setting('ad_text'))
    ad_lnk = urllib.parse.quote(get_setting('ad_link')) # Link qo'shildi
    adm = urllib.parse.quote(get_setting('admin_contact'))
    return f"{WEBAPP_URL}/index.html?l={course}&ed={end_d}&ad={ad_txt}&al={ad_lnk}&ac={adm}"

# --- TRACK JOIN (HISOB-KITOB) ---
async def track_join(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.chat_member: return
    
    result = update.chat_member
    chat_id = str(result.chat.id)
    
    targets = [c[0] for c in get_targets()]
    if chat_id not in targets: return

    new_status = result.new_chat_member.status
    old_status = result.old_chat_member.status
    
    is_join = new_status in [ChatMemberStatus.MEMBER, ChatMemberStatus.ADMINISTRATOR, ChatMemberStatus.RESTRICTED]
    was_not_member = old_status in [ChatMemberStatus.LEFT, ChatMemberStatus.KICKED, "kicked", "left"] or old_status is None

    if is_join and was_not_member:
        invite_link = result.invite_link
        
        if invite_link and invite_link.name and invite_link.name.isdigit():
            inviter_id = int(invite_link.name)
            
            if inviter_id == result.new_chat_member.user.id: return

            conn = get_db(); cur = conn.cursor()
            cur.execute("UPDATE users SET invites = invites + 1 WHERE user_id=?", (inviter_id,))
            cur.execute("UPDATE targets SET joined_count = joined_count + 1 WHERE channel_id=?", (chat_id,))
            conn.commit(); conn.close()
            
            try:
                req = int(get_setting('required_invites'))
                conn = get_db(); curr = conn.cursor().execute("SELECT invites, full_name FROM users WHERE user_id=?", (inviter_id,)).fetchone(); conn.close()
                invites_count = curr[0]
                inviter_name = curr[1]
                joined_name = result.new_chat_member.user.full_name

                # --- VAZIFA BAJARILDI ---
                if invites_count >= req:
                    url = generate_webapp_url_logic(inviter_name)
                    kb = [[InlineKeyboardButton("ğŸ“ KURSNI OCHISH (KIRISH)", web_app=WebAppInfo(url=url))]]
                    msg = (f"ğŸ‰ <b>TABRIKLAYMIZ!</b>\n\n"
                           f"ğŸ‘¤ {joined_name} qo'shildi.\n"
                           f"âœ… Siz {invites_count} ta odam yig'dingiz va vazifani bajardingiz!\n\n"
                           f"Kursni ko'rish uchun pastdagi tugmani bosing ğŸ‘‡")
                    await context.bot.send_message(inviter_id, msg, reply_markup=InlineKeyboardMarkup(kb), parse_mode=ParseMode.HTML)
                else:
                    msg = f"ğŸ‘¤ <b>Yangi a'zo qo'shildi!</b>\n({joined_name})\n\nğŸ“Š Jami: {invites_count}/{req}\nâ—ï¸ Yana {req - invites_count} ta qoldi."
                    await context.bot.send_message(inviter_id, msg, parse_mode=ParseMode.HTML)

            except Exception as e: print(f"Xato: {e}")

# --- OBUNA TEKSHIRUVI ---
async def check_subscription(user_id, bot):
    sponsors = get_sponsors()
    if not sponsors: return True, []
    not_joined = []
    for cid, title, url in sponsors:
        try:
            member = await bot.get_chat_member(chat_id=cid, user_id=user_id)
            if member.status not in [ChatMemberStatus.MEMBER, ChatMemberStatus.ADMINISTRATOR, ChatMemberStatus.CREATOR]:
                not_joined.append({'name': title, 'url': url})
        except: pass 
    return len(not_joined) == 0, not_joined

# --- MENU ---
async def show_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['state'] = None
    user = update.effective_user
    
    is_sub, channels = await check_subscription(user.id, context.bot)
    
    if not is_sub:
        kb = []
        for ch in channels: kb.append([InlineKeyboardButton(f"â• {ch['name']} ga qo'shilish", url=ch['url'])])
        kb.append([InlineKeyboardButton("âœ… Tekshirish", callback_data="check_sub")])
        text = "ğŸ”’ <b>Botdan to'liq foydalanish uchun, iltimos, quyidagi homiy kanallarga a'zo bo'ling:</b>"
        markup = InlineKeyboardMarkup(kb)
    else:
        kb = [[InlineKeyboardButton("ğŸ”— Link olish (Konkurs)", callback_data="get_link"), InlineKeyboardButton("ğŸ“Š Natijam", callback_data="stats")]]
        if user.id == MAIN_ADMIN_ID: kb.append([InlineKeyboardButton("âš™ï¸ Admin Panel", callback_data="admin_panel")])
        text = f"ğŸ‘‹ <b>Assalomu alaykum, {user.first_name}!</b>\n\nğŸ Konkursda ishtirok eting va <b>Bepul Kursni</b> yutib oling!\n\nBoshlash uchun quyidagi tugmani bosing ğŸ‘‡"
        markup = InlineKeyboardMarkup(kb)

    try:
        if update.callback_query: await update.callback_query.message.edit_text(text, reply_markup=markup, parse_mode=ParseMode.HTML)
        else: await update.message.reply_text(text, reply_markup=markup, parse_mode=ParseMode.HTML)
    except:
        await update.message.reply_text(text, reply_markup=markup, parse_mode=ParseMode.HTML)

# --- START ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    conn = get_db(); cur = conn.cursor()
    cur.execute("INSERT OR IGNORE INTO users (user_id, full_name, username, invites) VALUES (?, ?, ?, 0)", (user.id, user.full_name, user.username))
    conn.commit(); conn.close()
    await show_main_menu(update, context)

# --- CALLBACKS ---
async def callback_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data
    user = query.from_user
    context.user_data['state'] = None 

    if data == "back_home" or data == "check_sub":
        await query.answer()
        await show_main_menu(update, context)
        return

    if user.id != MAIN_ADMIN_ID:
        is_sub, _ = await check_subscription(user.id, context.bot)
        if not is_sub:
            await query.answer("Avval kanallarga a'zo bo'ling!", show_alert=True)
            await show_main_menu(update, context)
            return

    if data == "get_link":
        conn = get_db(); cur = conn.cursor()
        u_data = cur.execute("SELECT invite_link, invites, assigned_channel_id FROM users WHERE user_id=?", (user.id,)).fetchone()
        
        link = ""
        invites = 0
        if u_data and u_data[0]:
            link = u_data[0]; invites = u_data[1]
        else:
            res = get_next_target_channel()
            if not res:
                await query.answer("Konkurs kanallari topilmadi", show_alert=True); conn.close(); return
            
            target_cid, target_title = res
            try:
                invite = await context.bot.create_chat_invite_link(
                    chat_id=target_cid,
                    name=str(user.id),
                    member_limit=0
                )
                link = invite.invite_link
                cur.execute("UPDATE users SET invite_link=?, assigned_channel_id=? WHERE user_id=?", (link, target_cid, user.id))
                conn.commit()
            except Exception as e:
                await query.edit_message_text(f"âŒ Xato: Bot {target_title} kanalida Admin emas!\n{e}"); conn.close(); return

        conn.close()
        req = get_setting('required_invites')
        
        await query.edit_message_text(
            f"ğŸ”— <b>Sizning Konkurs Havolangiz:</b>\n\n{link}\n\nğŸ‘† Bu havolani tarqating. Do'stlar shu orqali qo'shilsa ball beriladi.\n\nğŸ“Š Natija: <b>{invites}/{req}</b>",
            parse_mode=ParseMode.HTML,
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("ğŸ”™ Orqaga", callback_data="back_home")]])
        )

    elif data == "stats":
        conn = get_db(); u_data = conn.cursor().execute("SELECT invites, pro_claimed